<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instagram DM + Video Call</title>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#fafafa; }
    .header { background:#fff; padding:15px; border-bottom:1px solid #dbdbdb; display:flex; justify-content:space-between; align-items:center; }
    .header h2 { margin:0; font-size:18px; }
    .messages { height:40vh; overflow-y:scroll; padding:10px; display:flex; flex-direction:column; gap:10px; }
    .message { max-width:70%; padding:10px; border-radius:15px; }
    .sent { align-self:flex-end; background:#dcf8c6; }
    .received { align-self:flex-start; background:#fff; border:1px solid #dbdbdb; }
    .input-box { display:flex; border-top:1px solid #dbdbdb; background:#fff; }
    .input-box input { flex:1; padding:10px; border:none; outline:none; font-size:16px; }
    .input-box button { padding:10px 20px; border:none; background:#0095f6; color:#fff; cursor:pointer; font-weight:bold; }
    .video-container { display:flex; justify-content:space-around; margin:10px 0; }
    video { width:45%; border:1px solid #dbdbdb; border-radius:10px; background:#000; }
    .room-info { padding:10px; background:#fff; border-bottom:1px solid #dbdbdb; }
    .link-box { display:flex; gap:10px; margin-top:5px; }
    .link-box input { flex:1; padding:5px; font-size:14px; }
    .link-box button { padding:5px 10px; font-size:14px; background:#0095f6; color:#fff; border:none; cursor:pointer; }
  </style>
</head>
<body>

  <div class="header">
    <h2>Rohit Jadhav</h2>
  </div>

  <div class="room-info">
    <div>Your Room Link (Share this with friend to join):</div>
    <div class="link-box">
      <input type="text" id="roomLink" readonly>
      <button onclick="copyLink()">Copy</button>
    </div>
  </div>

  <div class="messages" id="messages">
    <div class="message received">Hi! Kaise ho?</div>
    <div class="message sent">Main theek hoon, tum batao?</div>
  </div>

  <div class="input-box">
    <input type="text" id="messageInput" placeholder="Message...">
    <button onclick="sendMessage()">Send</button>
  </div>

  <div class="video-container">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <script>
    // --- Chat logic ---
    const messagesDiv = document.getElementById('messages');
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if(text !== '') {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message','sent');
        msgDiv.textContent = text;
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        input.value = '';
      }
    }

    function copyLink() {
      const input = document.getElementById('roomLink');
      input.select();
      input.setSelectionRange(0, 99999);
      document.execCommand('copy');
      alert('Room link copied!');
    }

    // --- Video Call logic with PeerJS ---
    let localStream;
    let peer;
    let currentCall;

    async function initCall() {
      // Generate unique Peer ID for this user
      const userId = 'peer-' + Math.random().toString(36).substring(2, 8);

      // Generate Room Link
      const link = window.location.origin + window.location.pathname + '?peer=' + userId;
      document.getElementById('roomLink').value = link;

      // Get camera/mic
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      document.getElementById('localVideo').srcObject = localStream;

      // Initialize PeerJS
      peer = new Peer(userId, {
        host: '0.peerjs.com',
        port: 443,
        secure: true
      });

      peer.on('open', id => {
        console.log('My Peer ID:', id);

        // Check if URL has ?peer=otherID
        const urlParams = new URLSearchParams(window.location.search);
        const otherId = urlParams.get('peer');
        if(otherId && otherId !== id) {
          // Call the other peer
          const call = peer.call(otherId, localStream);
          call.on('stream', remoteStream => {
            document.getElementById('remoteVideo').srcObject = remoteStream;
          });
          currentCall = call;
        }
      });

      // Answer incoming calls
      peer.on('call', call => {
        call.answer(localStream);
        call.on('stream', remoteStream => {
          document.getElementById('remoteVideo').srcObject = remoteStream;
        });
        currentCall = call;
      });

      peer.on('error', err => { console.error(err); alert('PeerJS Error: ' + err); });
    }

    initCall();
  </script>

</body>
</html>
